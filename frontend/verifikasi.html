<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifikasi Tiket QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; text-align: center; background: #f7f7f7; }
    h1 { color: #ff6b35; margin-top: 20px; }
    #reader { width: 320px; margin: 20px auto; }
    .result { background: #fff; padding: 15px; border-radius: 8px; width: 320px; margin: 10px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>Scan Tiket QR üé´</h1>
  <div id="reader"></div>
  <div class="result" id="result">Arahkan kamera ke QR code...</div>

  <script>
    function verifyTicket(data) {
      let tiket;
      try {
        tiket = JSON.parse(data);
      } catch {
        document.getElementById('result').innerHTML = "‚ùå QR tidak valid";
        return;
      }

    const apiBase = "10.10.10.127:3000"; // IP dari laptop kamu
        fetch(`http://${apiBase}/api/tiket/${tiket.id}`)
        .then(res => res.json())
        .then(r => {
          if (!r.success) {
            document.getElementById('result').innerHTML = "‚ùå Tiket tidak valid / dibatalkan.";
            return;
          }
          if (r.data.tiket_code.startsWith('CANCELLED')) {
            document.getElementById('result').innerHTML = "‚ùå Tiket ini sudah DIBATALKAN!";
          } else {
            document.getElementById('result').innerHTML = `
              ‚úÖ <b>Tiket Valid!</b><br>
              Nama: ${r.data.nama}<br>
              Kode: ${r.data.tiket_code}<br>
              Email: ${r.data.email}
            `;
          }
        })
        .catch(() => {
          document.getElementById('result').innerHTML = "‚ö†Ô∏è Gagal menghubungi server.";
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          devices[0].id,
          { fps: 10, qrbox: 250 },
          verifyTicket,
          err => { /* abaikan error kecil */ }
        );
      }
    });
  </script>
</body>
</html>
